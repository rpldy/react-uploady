version: 2.1
#orbs:
#    node: circleci/node@4.7.0

references:
    docker_image: &docker_image
        - image: cypress/base:14.17.6
          environment:
              TERM: xterm

commands:
    setup:
        description: "Setup command to install/bootstrap/build"
        steps:
            #            - run: "ls; pwd; PATH=$PATH:./node_modules/.bin"
            - run: yarn --pure-lockfile
            #- run: yarn bootstrap:pure
            - run: yarn build
    bundle:
        description: "Create UMD bundles"
        steps:
            - run: yarn bundle:prod
    prepare-e2e:
        description: "Prepare for cypress e2e tests"
        steps:
            - run: "ls; pwd"
            - run:
                  name: Install cypress
                  command: yarn cypress install
            - run:
                  name: Verify cypress
                  command: npx cypress verify
            - run:
                  name: Build Storybook
                  command: yarn sb:build:prod

jobs:
    setup:
        docker: *docker_image
        #          - image: cimg/node:14.17.6
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        steps:
            - checkout
            - restore_cache:
                  keys:
                      - v1-deps-{{ checksum "yarn.lock" }}
            - setup
            - save_cache:
                  key: v1-deps-{{ checksum "yarn.lock" }}
                  paths:
                      - node_modules
            -   persist_to_workspace:
                    root: .
                    paths:
                        - node_modules
                        - packages
    #                        - /home/circleci/.cache/Cypress

    test:
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        docker: *docker_image
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - run:
                  name: Test Code (lint, flow, jest, types)
                  command: yarn test:ci
                  environment:
                      JEST_JUNIT_OUTPUT_DIR: "reports/junit/js-test-results.xml"
            - store_test_results:
                  path: reports/junit
            - store_artifacts:
                  path: reports/junit
            - store_artifacts:
                  path: .jest-coverage
            - persist_to_workspace:
                  root: .
                  paths:
                      - .jest-coverage

    coverage:
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        docker: *docker_image
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - run:
                  name: Upload Coverage
                  command: yarn coverage
            - store_artifacts:
                  path: .jest-coverage

    bundle:
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        docker: *docker_image
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - bundle
            - store_artifacts:
                  path: bundle
            - persist_to_workspace:
                  root: .
                  paths:
                      - bundle

    cypress-prepare:
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        docker: *docker_image
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - prepare-e2e
            - persist_to_workspace:
                  root: .
                  paths:
                      - .sb-static

    cypress-run:
        #        working_directory: *workspace_root
        #        executor:
        #            name: node/default
        #            tag: *node_version
        docker: *docker_image
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - store_artifacts:
                  path: cypress/results

workflows:
    create-rpldy:
        jobs:
            - setup
            - test:
                  requires:
                      - setup
            - coverage:
                  requires:
                      - test
                  filters:
                      branches:
                          only: master
            - bundle:
                  requires:
                      - setup
            - cypress-prepare:
                  requires:
                      - setup
            - cypress-run:
                  requires:
                      - cypress-prepare
                      - bundle


#      - cypress/install:
#          name: Prepare E2E (cypress)
#          executor: cypress-node-14
#          requires:
#            - setup
#          yarn: true
#          cache-key: v1-deps-{{ checksum "yarn.lock" }}
#          # no need to run `yarn install` again, since was done already and modules are cached
#          install-command: "pwd; yarn sb:build:prod"
#          post-install:
#            # this sucks! need to find way to use output from bundle job!!! doesnt seem possible because cypress orb hardcodes - attach_workspace: at: ~/
#            - bundle
#      - cypress/run:
#          name: E2E (cypress)
#          executor: cypress-node-14
#          requires:
#            - Prepare E2E (cypress)
#          attach-workspace: true
#          yarn: true
#          cache-key: v1-deps-{{ checksum "yarn.lock" }}
#          start: yarn deps:serve
#          wait-on: "http://localhost:8001"
#          #            record: true
#          #            parallel: true
#          #            parallelism: 2
#          #            group: rpldy-ci
#          store_artifacts: true
#          post-steps:
#            - store_test_results:
#                path: cypress/results

#requires paid plan:
#executors:
#  mac:
#    macos:
#      xcode: 10.1.0
#        - cypress/run:
#            name: Mac E2E (cypress)
#            executor: mac
#            yarn: true
#            start: yarn sb:serve
#            wait-on: "http://localhost:8001"


#    build-and-deploy:
#      jobs:
#        - build-and-deploy:
#          filters:
#              branches:
#                  only: master
